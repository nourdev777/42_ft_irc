# Техническое описание проекта IRC сервера

## Часть 1: Общее описание проекта и архитектура

**IRC (Internet Relay Chat)** — это протокол для текстового общения в реальном времени через интернет.

Этот проект реализует IRC сервер на языке **C++**, который:
- Обрабатывает подключения пользователей,
- Управляет каналами,
- Пересылает сообщения между пользователями.

### Основные компоненты системы:
- **Server** — главный класс, управляющий подключениями, сообщениями и координацией.
- **User** — класс, представляющий пользователя (ник, имя, IP и т.д.).
- **Channel** — класс управления каналами, участниками и правами.

### Общий поток выполнения:
1. Сервер запускается с параметрами порта и пароля.
2. Создаётся сокет и настраивается прослушивание порта.
3. Цикл `poll` ожидает событий на сокетах.
4. При подключении клиента создается объект `User`.
5. Сервер обрабатывает команды пользователей и управляет каналами.

---

## Часть 2: Сетевое взаимодействие и управление соединениями

### Создание сервера и принятие подключений

#### 1. Создание сокета (`createSocket`):
- Используется `socket(AF_INET, SOCK_STREAM, 0)`.
- `AF_INET` — IPv4, `SOCK_STREAM` — TCP.

#### 2. Привязка сокета (`bindSocket`):
- Привязка через `bind` с использованием `sockaddr_in`.
- `INADDR_ANY` — на любой интерфейс.
- Порт преобразуется через `htons`.

#### 3. Прослушивание соединений (`listenSocket`):
- Сокет переводится в режим прослушивания через `listen`.
- `MAX_CLIENTS` — максимум подключений в очереди.

#### 4. Принятие подключений (`acceptConection`):
- Используется `accept`.
- Создаётся новый файловый дескриптор.
- Сохраняется IP и хост клиента.
- Новый клиент добавляется в вектор `_fds`.
- Создается объект `User`.

### Опрос и обработка событий

#### Цикл опроса:
- Используется `poll` для неблокирующей обработки соединений.

#### Обработка чтения данных:
- `POLLIN` на главном сокете — новое соединение.
- `POLLIN` на клиентском сокете — входящие данные.
- Данные читаются через `receiveMsg`.
- `0 байт` — клиент отключился, удаляется.

#### Обработка данных для записи:
- `POLLOUT` на клиентском сокете — можно отправлять данные.
- Отправка сообщений пользователю из буфера.

---

## Часть 3: Аутентификация и обработка команд

### Аутентификация пользователей (`authenticateUser`):
- Пользователь передаёт:
  - Пароль (`PASS`),
  - Ник (`NICK`),
  - Имя (`USER`).
- Проверка пароля и уникальности ника.
- При успешной проверке:
  - Отправляется приветствие,
  - `_isAuth = true`.

### Проверка дублирования ника (`checkDupNickname`):
- Проверка уникальности ника.
- При занятом нике — сообщение об ошибке.

### Обработка команд IRC (`isCommand`, `switch-case`):
- Команды в верхнем регистре, сопоставляются с enum.
- Обрабатываются через `switch-case`:
  - `NICK` — установка/изменение ника,
  - `USER` — установка имени пользователя,
  - `PING` → `PONG`,
  - `QUIT` — отключение пользователя,
  - `JOIN` — присоединение/создание канала,
  - `PRIVMSG`/`MSG` — личное/канальное сообщение,
  - `PART` — покидание канала,
  - `INVITE` — приглашение,
  - `TOPIC` — установка/просмотр темы,
  - `KICK` — исключение,
  - `MODE` — изменение режима канала/пользователя.

---

## Часть 4: Управление каналами и пользователями

### Канал (`Channel`):

#### Создание:
- Создается при первом `JOIN`.
- Создатель — владелец.
- Установка имени, темы и параметров.

#### Участники:
- Карты для хранения:
  - `members` — участники,
  - `operators` — операторы,
  - `invited` — приглашенные,
  - `banned` — заблокированные.
- Методы добавления/удаления.

#### Права и режимы:
- Владелец — полный контроль.
- Операторы — управление режимами и исключениями.
- Поддерживаемые режимы:
  - `+i` — только по приглашению,
  - `+t` — только операторы могут менять тему,
  - `+l` — лимит участников,
  - `+k` — пароль.

#### Рассылка сообщений:
- Метод `broadcast` рассылает сообщение всем участникам.
- Возможность исключения конкретного пользователя.

### Пользователь (`User`):

#### Атрибуты:
- Файловый дескриптор,
- Ник, имя,
- IP, хост,
- Флаг аутентификации,
- Буферы сообщений.

#### Управление сообщениями:
- Получение, обработка, отправка сообщений.
- Разбор текста на команды и аргументы.

---

## Часть 5: Обработка сигналов и завершение работы

### Обработка сигналов:

#### Регистрация:
- `SIGINT` (Ctrl+C), `SIGTERM` обрабатываются функциями.
- Используется глобальная переменная `globalServerInstance`.

#### Обработчики (`sigIntHandler`, `sigTermHandler`):
- Вызывается `shutdownServer`.

### Корректное завершение:

#### Метод `shutdownServer`:
- Устанавливает `_disconnect` → завершает цикл.
- Закрывает сокеты.
- Освобождает ресурсы.

#### Освобождение ресурсов:
- Закрытие всех сокетов (`close`).
- Очистка векторов и структур.

---

## Часть 6: Проверка аргументов командной строки

### Парсинг (`parsingCommandLine`):
- Ожидается 3 аргумента: исполняемый файл, порт, пароль.
- Вызываются `checkPort`, `checkPass`.

### Проверка порта (`checkPort`):
- Проверка корректности:
  - Преобразование в число,
  - Диапазон: `1024–65535`,
  - Только цифры.

### Проверка пароля (`checkPass`):
- Пароль не должен быть пустым.
- Без пробелов.

---

## Заключение

**IRC сервер** — это комплексная система, включающая:

- Сетевое программирование,
- Управление пользователями и каналами,
- Обработку команд IRC,
- Объектно-ориентированное проектирование,
- Обработку сигналов и корректное завершение,
- Валидацию входных данных.

### Ключевые технические элементы:
- Сокеты для сетевого взаимодействия,
- Неблокирующий I/O через `poll`,
- Классы `User` и `Channel` для инкапсуляции логики,
- Обработка `SIGINT` и `SIGTERM` сигналов,
- Проверка аргументов запуска.

Реализация соответствует базовому функционалу IRC:
- Создание/управление каналами,
- Приватные сообщения,
- Управление правами пользователей,
- Поддержка режимов каналов и пользователей.

